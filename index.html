<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯ | Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„Ø¹Ù‚Ù„ ÙŠØªÙ†ÙØ³</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#fff7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;

      --pink:#ec4899;
      --purple:#a855f7;
      --mint:#34d399;
      --sky:#38bdf8;

      --radius:18px;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --ring:rgba(236,72,153,.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:linear-gradient(135deg,var(--pink),var(--purple),var(--sky));
      color:#fff;
      padding:28px 16px;
      text-align:center;
    }
    header h1{ margin:0 0 6px; font-size:30px; }
    header p{ margin:0; opacity:.95; }

    .wrap{ max-width:1200px; margin:auto; padding:22px 16px 40px; }

    .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      margin-bottom:14px;
    }

    .pill{
      background:var(--card);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:var(--shadow);
      font-size:14px;
      display:flex; gap:8px; align-items:center;
    }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin:14px 0 18px; justify-content:center; }
    .tab{
      border:0; cursor:pointer;
      background:var(--card);
      padding:12px 16px;
      border-radius:999px;
      box-shadow:var(--shadow);
      font-weight:800;
      color:var(--text);
      transition: transform .2s ease;
    }
    .tab:hover{ transform:translateY(-2px); }
    .tab.active{
      background:linear-gradient(135deg,#fff0f7,#f5f3ff,#effaff);
      box-shadow:0 0 0 4px var(--ring), var(--shadow);
      color:var(--pink);
    }

    .grid{ display:grid; grid-template-columns: 1.3fr .7fr; gap:18px; }
    @media (max-width: 1024px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
    }

    .card h2, .sectionTitle{ color:var(--pink); margin:0 0 10px; }
    .muted{ color:var(--muted); }

    .kpis{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    @media (max-width:700px){ .kpis{ grid-template-columns:1fr; } }

    .kpi{
      background:linear-gradient(180deg,#ffffff,#fff7fb);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .kpi .label{ font-size:13px; color:var(--muted); }
    .kpi .value{ font-size:28px; font-weight:900; color:var(--purple); }

    .charts{ display:grid; gap:16px; margin-top:16px; }
    canvas{ background:#fff; border-radius:16px; padding:14px; box-shadow:var(--shadow); max-height:420px; width:100%; }

    footer{
      text-align:center;
      padding:18px;
      color:var(--muted);
      font-size:14px;
    }

    .status{ margin-top:10px; font-size:14px; }
    .status.ok{ color:#059669; }
    .status.err{ color:#dc2626; }

    .list{ display:grid; gap:10px; }
    .item{
      border:1px solid #eef2f7;
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .item b{ color:var(--purple); }

    .cta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      text-decoration:none;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      background:linear-gradient(135deg,#fff0f7,#f5f3ff,#effaff);
      color:var(--text);
      font-weight:800;
      border:1px solid rgba(0,0,0,.06);
    }

    [hidden]{ display:none !important; }

    /* Gallery grid */
    .gallery{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    @media (max-width: 900px){ .gallery{ grid-template-columns:repeat(2,1fr); } }
    @media (max-width: 520px){ .gallery{ grid-template-columns:1fr; } }
    .photo{
      width:100%;
      aspect-ratio:4/3;
      object-fit:cover;
      border-radius:16px;
      box-shadow:var(--shadow);
      background:#f3f4f6;
      cursor:pointer;
    }

    /* Lightbox (slider + thumbs) */
    .lb{ position:fixed; inset:0; display:none; background:rgba(0,0,0,.75); z-index:9999; padding:14px; }
    .lb.open{ display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .lbClose{ position:absolute; top:12px; right:12px; width:44px; height:44px; border-radius:999px; background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.25); color:#fff; cursor:pointer; font-size:18px; }
    .lbNav{ position:absolute; top:50%; transform:translateY(-50%); width:54px; height:54px; border-radius:999px; background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.25); color:#fff; cursor:pointer; font-size:46px; display:grid; place-items:center; }
    .lbPrev{ left:12px; }
    .lbNext{ right:12px; }
    .lbStage{ width:min(1100px, 98vw); height:min(70vh, 560px); display:flex; align-items:center; justify-content:center; }
    .lbMedia{ width:100%; height:100%; border:0; border-radius:18px; box-shadow:0 20px 50px rgba(0,0,0,.35); background:#111; object-fit:contain; display:none; }
    .lbCaption{ color:#fff; margin-top:10px; text-align:center; opacity:.92; }
    .lbThumbs{ width:min(1100px, 98vw); display:flex; gap:10px; overflow:auto; padding:10px 2px 4px; margin-top:10px; }
    .lbThumb{ flex:0 0 auto; width:86px; height:56px; border-radius:12px; border:2px solid rgba(255,255,255,.22); overflow:hidden; background:rgba(255,255,255,.08); cursor:pointer; opacity:.85; }
    .lbThumb.active{ border-color: rgba(236,72,153,.95); opacity:1; }
    .lbThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .lbThumb .play{ width:100%; height:100%; display:grid; place-items:center; color:#fff; font-size:18px; background:linear-gradient(135deg, rgba(236,72,153,.35), rgba(56,189,248,.25)); }

    @media (max-width: 768px){
      header h1{ font-size:24px; }
      canvas{ max-height:320px; }
      .lbStage{ height:min(56vh, 420px); }
      .lbNav{ width:48px; height:48px; font-size:40px; }
      .lbThumb{ width:74px; height:50px; }
    }

    @media (max-width: 480px){
      header{ padding:20px 12px; }
      header p{ font-size:14px; }
      .pill{ font-size:12px; padding:8px 10px; }
      .tab{ padding:10px 12px; font-size:14px; }
      .card{ padding:14px; }
      canvas{ max-height:260px; }
    }
  </style>
</head>

<body>
  <!-- Lightbox -->
  <div id="lightbox" class="lb" aria-hidden="true">
    <button id="lbClose" class="lbClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    <button id="lbPrev" class="lbNav lbPrev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚">â®</button>

    <div class="lbStage">
      <img id="lightboxImg" class="lbMedia" alt="" />
      <iframe id="lightboxYt" class="lbMedia" title="YouTube"
        allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen></iframe>
    </div>

    <button id="lbNext" class="lbNav lbNext" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ">â¯</button>
    <div id="lbCaption" class="lbCaption"></div>
    <div id="lbThumbs" class="lbThumbs"></div>
  </div>

  <header>
    <h1>Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„Ø¹Ù‚Ù„ ÙŠØªÙ†ÙØ³</h1>
    <p>ÙˆÙ‚Ù ØªØ¹Ù„ÙŠÙ…ÙŠ â€“ STEM | Ø±Ø¤ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© 2030</p>
  </header>

  <div class="wrap">
    <div class="topbar">
      <div class="pill">ğŸ“… Ø³Ù†Ø© Ø§Ù„ØªØ£Ø³ÙŠØ³: <b>2018</b></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="overview">DashBoard</button>
      <button class="tab" data-tab="consulting">Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</button>
      <button class="tab" data-tab="achievements">Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</button>
      <button class="tab" data-tab="photos">Ø§Ù„ØµÙˆØ±</button>
      <button class="tab" data-tab="partners">Ø§Ù„Ø´Ø±ÙƒØ§Ø¡</button>
    </div>

    <!-- Overview -->
    <section id="tab-overview">
      <div class="grid">
        <div class="card">
          <h2>Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©</h2>
          <p>
            <b>Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„Ø¹Ù‚Ù„ ÙŠØªÙ†ÙØ³</b> Ù…Ø¨Ø§Ø¯Ø±Ø© <b>ÙˆÙ‚Ù ØªØ¹Ù„ÙŠÙ…ÙŠ</b> ØªØ£Ø³Ø³Øª Ø¹Ø§Ù… <b>2018</b>ØŒ
            ØªÙØ¹Ù†Ù‰ Ø¨ØªÙ†Ù…ÙŠØ© Ø§Ù„ØªÙÙƒÙŠØ± ÙˆØ§Ù„Ø§Ø¨ØªÙƒØ§Ø± Ø¹Ø¨Ø± Ù…Ø´Ø§Ø±ÙŠØ¹ ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ <b>STEM</b>ØŒ
            ÙˆØ¨Ù…Ø§ ÙŠÙ†Ø³Ø¬Ù… Ù…Ø¹ Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª <b>Ø±Ø¤ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© 2030</b>.
          </p>
          <div id="status" class="status muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦</div>
        </div>

        <div class="card">
          <h2>Ù…Ù„Ø®Øµ Ø¥Ø­ØµØ§Ø¦ÙŠ</h2>
          <div class="kpis">
            <div class="kpi"><div class="label">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div><div id="kpiProjects" class="value">â€”</div></div>
            <div class="kpi"><div class="label">Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª</div><div id="kpiEvents" class="value">â€”</div></div>
            <div class="kpi"><div class="label">Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙˆÙ†</div><div id="kpiTrainees" class="value">â€”</div></div>
          </div>

          <div class="cta">
            <a class="btn" href="https://noofkhabti.my.canva.site/dag-oorc6gq" target="_blank" rel="noopener">ğŸ§  ØµÙØ­Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</a>
          </div>
        </div>
      </div>

      <div class="charts">
        <div class="card"><h3 class="sectionTitle">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø³Ù†Ø©</h3><canvas id="projectsChart"></canvas></div>
        <div class="card"><h3 class="sectionTitle">Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</h3><canvas id="eventsChart"></canvas></div>
        <div class="card"><h3 class="sectionTitle">Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙˆÙ† (Ø·Ù„Ø§Ø¨ / Ø·Ø§Ù„Ø¨Ø§Øª)</h3><canvas id="studentsChart"></canvas></div>
        <div class="card"><h3 class="sectionTitle">Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙˆÙ† Ø³Ù†ÙˆÙŠÙ‹Ø§</h3><canvas id="traineesByYearChart"></canvas></div>
      </div>
    </section>

    <!-- Consulting -->
    <section id="tab-consulting" hidden>
      <div class="card">
        <h2>Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</h2>
        <p class="muted" style="line-height:1.9; margin-top:0;">
        
        </p>
        <div id="consultingList" class="list" style="margin-top:10px;"></div>

        <div class="cta">
          <a class="btn" href="https://noofkhabti.my.canva.site/dag-oorc6gq" target="_blank" rel="noopener">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª </a>
        </div>
      </div>
    </section>

    <!-- Achievements -->
    <section id="tab-achievements" hidden>
      <div class="card">
        <h2>Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</h2>
        <div id="achievementsList" class="list"></div>
      </div>
    </section>

    <!-- Photos -->
    <section id="tab-photos" hidden>
      <div class="card">
        <h2>Ø§Ù„ØµÙˆØ±</h2>
        <div id="photosGrid" class="gallery"></div>
      </div>
    </section>

    <!-- Partners -->
    <section id="tab-partners" hidden>
      <div class="card">
        <h2>Ø§Ù„Ø´Ø±ÙƒØ§Ø¡</h2>
        <div id="partnersList" class="list"></div>
      </div>
    </section>

  </div>

  <footer>Â© Ù†ÙˆÙ Ø®Ø¨ØªÙŠ â€” Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„Ø¹Ù‚Ù„ ÙŠØªÙ†ÙØ³</footer>

<script>
  const SHEETS = {
    projects: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTdJoeiY6gtt0NaEWYFZxmhMYxT-0EPug4za-8Wl1xXI8o6PYlLn56g-Dv15i0dqsENN9Zai1ROlMA6/pub?output=csv",
    events: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQc-r6wYcwCrEnYNn1A7iFr9Lj9wi78N2-w1enXOA3UgrRSccpLkL-wi4wuO8c45ItTo2Pzz0AP7p6l/pub?output=csv",
    trainees: "https://docs.google.com/spreadsheets/d/e/2PACX-1vS7jelgXvthN4fFi_HnZ0N9WZqOqUE1tb7sj_fH6GFDvaxQE7jZqVXQrTo2_WF8QLzHDOjHc2MPsTDc/pub?output=csv",
    achievements: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSdRNIFnC84P61R0LD57jfhTPO0iX6elBHk1wx4kDM-V9fr9EgUGp7caAhU736nymYZ317-v1sQzZ8Y/pub?output=csv",
    photos: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuaJBwN-JC6L2ANhu3tBITSSlY8Ph_11A-8YMF6_aNVrTX7zfZYBRWsW19qv3Sav0TniXmWWkZpMYA/pub?output=csv",
    partners: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSi20NWBWlJKeq8P9g_YGTVI8bilx6GNwzrvW3co1_R4bdN6n3B-q7akjVs0AIcFsiSi8C1eFGGxhG/pub?output=csv",
    consulting: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlliIursrmuf5kvjsO7vW05oJjCmhMZngG-x3gHHD0V40gueLfyiJUh9huTA0oyi5xJKNuuZ2FWQMT/pub?output=csv"
  };

  const num = (v) => {
    const n = Number(String(v ?? "").replace(/[^0-9.\-]/g, ""));
    return Number.isFinite(n) ? n : 0;
  };

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }

  function splitCsvLine(line){
    const out=[]; let cur=""; let q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){
        if(q && line[i+1]==='"'){ cur+='"'; i++; }
        else q=!q;
      } else if(c===',' && !q){ out.push(cur); cur=""; }
      else cur+=c;
    }
    out.push(cur);
    return out.map(s=>s.trim());
  }

  function parseCsv(text){
    const lines = String(text ?? "").replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
    if(!lines.length) return [];
    const headers = splitCsvLine(lines[0]).map(h=>h.replace(/^\uFEFF/,''));
    return lines.slice(1).map(l=>{
      const cells = splitCsvLine(l);
      const obj={};
      headers.forEach((h,idx)=> obj[h]= (cells[idx] ?? "").trim());
      return obj;
    });
  }

  async function loadCSV(url){
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error(`CSV fetch failed (HTTP ${res.status})`);
    const text = await res.text();
    return parseCsv(text);
  }

  function setStatus(msg, ok){
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = 'status ' + (ok ? 'ok' : 'err');
  }

  // Tabs
  const panes = Array.from(document.querySelectorAll('section[id^="tab-"]'));
  function showPane(id){
    panes.forEach(p=> p.hidden = (p.id !== id));
  }
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      showPane('tab-'+btn.dataset.tab);
    });
  });
  showPane('tab-overview');

  // Charts
  let chProjects=null, chEvents=null, chStudents=null, chTraineesByYear=null;
  const destroy = (ch)=>{ if(ch) ch.destroy(); return null; };

  function renderCharts(projects, events, trainees){
    const yearsP = projects.map(r=>String(r.Year ?? r.year ?? '').trim()).filter(Boolean);
    const countsP = projects.map(r=>num(r.ProjectsCount ?? r.projects ?? r.Count ?? r.count));

    const labelsE = events.map(r=>String(r.Type ?? r.type ?? r.Category ?? r.category ?? '').trim()).filter(Boolean);
    const countsE = events.map(r=>num(r.Count ?? r.count ?? r.EventsCount ?? r.events));

    const yearsT = trainees.map(r=>String(r.Year ?? r.year ?? '').trim()).filter(Boolean);
    const female = trainees.map(r=>num(r.Female ?? r.female ?? r.Girls ?? r.girls));
    const male   = trainees.map(r=>num(r.Male ?? r.male ?? r.Boys ?? r.boys));

    document.getElementById('kpiProjects').textContent = countsP.reduce((a,b)=>a+b,0).toLocaleString('ar-SA');
    document.getElementById('kpiEvents').textContent = countsE.reduce((a,b)=>a+b,0).toLocaleString('ar-SA');
    document.getElementById('kpiTrainees').textContent = (female.reduce((a,b)=>a+b,0) + male.reduce((a,b)=>a+b,0)).toLocaleString('ar-SA');

    chProjects = destroy(chProjects);
    chProjects = new Chart(document.getElementById('projectsChart'),{
      type:'line',
      data:{ labels:yearsP, datasets:[{ label:'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹', data:countsP, tension:0.35, fill:true }] },
      options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });

    chEvents = destroy(chEvents);
    chEvents = new Chart(document.getElementById('eventsChart'),{
      type:'bar',
      data:{ labels:labelsE, datasets:[{ label:'Ø¹Ø¯Ø¯ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª', data:countsE }] },
      options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });

    chStudents = destroy(chStudents);
    const sumF = female.reduce((a,b)=>a+b,0);
    const sumM = male.reduce((a,b)=>a+b,0);
    chStudents = new Chart(document.getElementById('studentsChart'),{
      type:'doughnut',
      data:{ labels:['Ø·Ø§Ù„Ø¨Ø§Øª','Ø·Ù„Ø§Ø¨'], datasets:[{ data:[sumF,sumM] }] },
      options:{ plugins:{ legend:{ position:'bottom' } } }
    });

    chTraineesByYear = destroy(chTraineesByYear);
    chTraineesByYear = new Chart(document.getElementById('traineesByYearChart'),{
      type:'line',
      data:{ labels:yearsT, datasets:[{ label:'Ø·Ø§Ù„Ø¨Ø§Øª', data:female, tension:0.35 }, { label:'Ø·Ù„Ø§Ø¨', data:male, tension:0.35 }] },
      options:{ plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function renderAchievements(rows){
    const box = document.getElementById('achievementsList');
    box.innerHTML = '';
    if(!rows.length){ box.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>'; return; }
    rows.slice(0,200).forEach(r=>{
      const title = r.Title ?? r.title ?? 'Ø¥Ù†Ø¬Ø§Ø²';
      const date  = r.Date ?? r.date ?? '';
      const desc  = r.Description ?? r.description ?? '';
      const el = document.createElement('div');
      el.className='item';
      el.innerHTML = `<b>${escapeHtml(title)}</b> <span class="muted">${escapeHtml(date)}</span><div class="muted" style="margin-top:6px; line-height:1.7;">${escapeHtml(desc)}</div>`;
      box.appendChild(el);
    });
  }

  function renderPartners(rows){
    const box = document.getElementById('partnersList');
    box.innerHTML = '';
    if(!rows.length){ box.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>'; return; }
    rows.slice(0,200).forEach(r=>{
      const name = r.Name ?? r.name ?? 'Ø´Ø±ÙŠÙƒ';
      const type = r.Type ?? r.type ?? '';
      const note = r.Note ?? r.note ?? '';
      const el = document.createElement('div');
      el.className='item';
      el.innerHTML = `<b>${escapeHtml(name)}</b> <span class="muted">${escapeHtml(type)}</span><div class="muted" style="margin-top:6px; line-height:1.7;">${escapeHtml(note)}</div>`;
      box.appendChild(el);
    });
  }

  // Consulting CSV -> list
  function renderConsulting(rows){
    const box = document.getElementById('consultingList');
    box.innerHTML = '';
    if(!rows.length){ box.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª. Ø£Ø¶ÙŠÙÙŠÙ‡Ø§ ÙÙŠ Ø´ÙŠØª Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª.</div>'; return; }

    const mapped = rows.map(r=>({
      type: String(r.Type ?? r.type ?? r["Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©"] ?? r["Ù†ÙˆØ¹"] ?? '').trim(),
      link: String(r.Link ?? r.link ?? r["Ø§Ù„Ø±Ø§Ø¨Ø·"] ?? r.URL ?? r.url ?? '').trim(),
      note: String(r.Note ?? r.note ?? r["Ù…Ù„Ø§Ø­Ø¸Ø©"] ?? '').trim()
    })).filter(x=>x.type || x.link);

    if(!mapped.length){
      box.innerHTML = '<div class="muted">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØºÙŠØ± ÙˆØ§Ø¶Ø­Ø©. Ø§Ø³ØªØ®Ø¯Ù…ÙŠ (Type, Link) Ø£Ùˆ (Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø©, Ø§Ù„Ø±Ø§Ø¨Ø·).</div>';
      return;
    }

    mapped.slice(0,200).forEach(x=>{
      const el = document.createElement('div');
      el.className='item';
      el.innerHTML = `
        <b>${escapeHtml(x.type || 'Ø§Ø³ØªØ´Ø§Ø±Ø©')}</b>
        ${x.note ? `<div class="muted" style="margin-top:6px; line-height:1.7;">${escapeHtml(x.note)}</div>` : ``}
        ${x.link ? `<div class="cta" style="margin-top:10px;"><a class="btn" href="${escapeHtml(x.link)}" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</a></div>` : `<div class="muted" style="margin-top:8px;">(Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø·)</div>`}
      `;
      box.appendChild(el);
    });
  }

  // Google Drive dynamic show (try best candidates)
  function extractDriveId(url){
    const s = String(url||'').trim();
    let m = s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    if(m) return m[1];
    m = s.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if(m) return m[1];
    return null;
  }
  function buildImageCandidates(rawUrl){
    const url = String(rawUrl||'').trim();
    const id = extractDriveId(url);
    if(!id) return [url];
    return [
      `https://drive.google.com/thumbnail?id=${id}&sz=w1600`,
      `https://lh3.googleusercontent.com/d/${id}=w1600`,
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.usercontent.google.com/uc?id=${id}&export=view`,
      url
    ];
  }

  // YouTube helpers (no autoplay)
  function isYouTube(url){ return /youtube\.com\/watch\?v=|youtu\.be\//i.test(String(url||'')); }
  function getYouTubeId(url){
    const u = String(url||'');
    let m = u.match(/youtube\.com\/watch\?v=([a-zA-Z0-9_-]{6,})/);
    if(m) return m[1];
    m = u.match(/youtu\.be\/([a-zA-Z0-9_-]{6,})/);
    if(m) return m[1];
    m = u.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]{6,})/);
    if(m) return m[1];
    return null;
  }
  function ytThumb(id){ return `https://i.ytimg.com/vi/${id}/mqdefault.jpg`; }

  function renderPhotos(rows){
    const grid = document.getElementById('photosGrid');
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightboxImg');
    const lbYt = document.getElementById('lightboxYt');
    const lbPrev = document.getElementById('lbPrev');
    const lbNext = document.getElementById('lbNext');
    const lbClose = document.getElementById('lbClose');
    const lbThumbs = document.getElementById('lbThumbs');
    const lbCaption = document.getElementById('lbCaption');

    const items = [];
    let current = 0;

    const openLb = ()=>{ lb.classList.add('open'); document.body.style.overflow='hidden'; };
    const closeLb = ()=>{ lb.classList.remove('open'); document.body.style.overflow=''; lbYt.src=''; };

    function setMedia(type){
      lbImg.style.display = type==='image' ? 'block' : 'none';
      lbYt.style.display  = type==='youtube' ? 'block' : 'none';
      if(type!=='youtube') lbYt.src='';
    }

    function renderThumbs(){
      lbThumbs.innerHTML='';
      items.forEach((it,idx)=>{
        const d = document.createElement('div');
        d.className = 'lbThumb' + (idx===current ? ' active':'' );
        if(it.type==='image'){
          const im = document.createElement('img'); im.src = it.thumb; d.appendChild(im);
        } else {
          const play = document.createElement('div'); play.className='play'; play.textContent='â–¶'; d.appendChild(play);
        }
        d.onclick = ()=> show(idx);
        lbThumbs.appendChild(d);
      });
    }

    function show(i){
      if(!items.length) return;
      if(i<0) i = items.length-1;
      if(i>=items.length) i = 0;
      current = i;
      const it = items[current];
      lbCaption.textContent = it.caption || '';

      if(it.type==='image'){
        setMedia('image');
        const cands = it.candidates;
        let ci = 0;
        lbImg.onerror = ()=>{ ci++; if(ci<cands.length) lbImg.src = cands[ci]; };
        lbImg.src = cands[0];
      } else {
        setMedia('youtube');
        lbYt.src = `https://www.youtube.com/embed/${it.ytid}?rel=0`; // Ø¨Ø¯ÙˆÙ† autoplay
      }

      renderThumbs();
    }

    const next = ()=> show(current+1);
    const prev = ()=> show(current-1);

    grid.innerHTML='';
    if(!rows.length){ grid.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±.</div>'; return; }

    rows.slice(0,200).forEach(r=>{
      const raw = r.ImageURL ?? r.image ?? r.URL ?? r.url;
      if(!raw) return;
      const cap = r.Caption ?? r.caption ?? '';

      if(isYouTube(raw)){
        const id = getYouTubeId(raw);
        if(!id) return;
        const thumb = ytThumb(id);
        const index = items.length;
        items.push({ type:'youtube', ytid:id, thumb, caption:cap });

        const wrap = document.createElement('div');
        const img = document.createElement('img');
        img.className='photo'; img.loading='lazy'; img.src = thumb;
        img.onclick = ()=>{ openLb(); show(index); };
        wrap.appendChild(img);
        if(cap){ const c=document.createElement('div'); c.className='muted'; c.style.marginTop='6px'; c.textContent=cap; wrap.appendChild(c); }
        grid.appendChild(wrap);
        return;
      }

      const candidates = buildImageCandidates(raw);
      const index = items.length;
      items.push({ type:'image', candidates, thumb:candidates[0], caption:cap });

      const wrap = document.createElement('div');
      const img = document.createElement('img');
      img.className='photo'; img.loading='lazy'; img.alt = cap || 'ØµÙˆØ±Ø©';

      let ti=0;
      img.onerror = ()=>{ ti++; if(ti<candidates.length) img.src=candidates[ti]; };
      img.src = candidates[0];
      img.onclick = ()=>{ openLb(); show(index); };

      wrap.appendChild(img);
      if(cap){ const c=document.createElement('div'); c.className='muted'; c.style.marginTop='6px'; c.textContent=cap; wrap.appendChild(c); }
      grid.appendChild(wrap);
    });

    lbPrev.onclick = (e)=>{ e.stopPropagation(); prev(); };
    lbNext.onclick = (e)=>{ e.stopPropagation(); next(); };
    lbClose.onclick = (e)=>{ e.stopPropagation(); closeLb(); };
    lb.addEventListener('click', (e)=>{ if(e.target===lb) closeLb(); });

    document.addEventListener('keydown', (e)=>{
      if(!lb.classList.contains('open')) return;
      if(e.key==='ArrowRight') next();
      if(e.key==='ArrowLeft') prev();
      if(e.key==='Escape') closeLb();
    });
  }

  // Load data
  (async()=>{
    try{
      const results = await Promise.allSettled([
        loadCSV(SHEETS.projects),
        loadCSV(SHEETS.events),
        loadCSV(SHEETS.trainees),
        loadCSV(SHEETS.achievements),
        loadCSV(SHEETS.photos),
        loadCSV(SHEETS.partners),
        loadCSV(SHEETS.consulting),
      ]);

      const names = ['projects','events','trainees','achievements','photos','partners','consulting'];
      const data = {};
      const failed = [];
      results.forEach((r,i)=>{
        if(r.status==='fulfilled') data[names[i]] = r.value;
        else failed.push(names[i]);
      });

      if(data.projects && data.events && data.trainees) renderCharts(data.projects, data.events, data.trainees);
      if(data.achievements) renderAchievements(data.achievements);
      if(data.photos) renderPhotos(data.photos);
      if(data.partners) renderPartners(data.partners);
      if(data.consulting) renderConsulting(data.consulting);

      if(failed.length){
        setStatus('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ… (ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù„Ù… ØªÙØ­Ù…Ù‘Ù„)', true);
        console.warn('Failed CSV:', failed);
      } else {
        setStatus('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…', true);
      }
    } catch(e){
      console.error(e);
      setStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„/Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', false);
    }
  })();
</script>

</body>
</html>
