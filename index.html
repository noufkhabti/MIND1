<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯ | Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„Ø¹Ù‚Ù„ ÙŠØªÙ†ÙØ³</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#fff7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;

      --pink:#ec4899;
      --purple:#a855f7;
      --mint:#34d399;
      --sky:#38bdf8;

      --radius:18px;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --ring:rgba(236,72,153,.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:linear-gradient(135deg,var(--pink),var(--purple),var(--sky));
      color:#fff;
      padding:28px 16px;
      text-align:center;
      animation: fadeDown .9s ease both;
    }
    header h1{ margin:0 0 6px; font-size:30px; }
    header p{ margin:0; opacity:.95; }

    .wrap{ max-width:1200px; margin:auto; padding:22px 16px 40px; }

    .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      margin-bottom:14px;
      animation: fadeUp .9s ease both .15s;
    }

    .pill{
      background:var(--card);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:var(--shadow);
      font-size:14px;
      transition: transform .3s ease, box-shadow .3s ease;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill:hover{ transform:translateY(-4px); box-shadow:0 16px 30px rgba(0,0,0,.12); }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:14px 0 18px;
      animation: fadeUp .9s ease both .25s;
      justify-content:center;
    }
    .tab{
      border:0;
      cursor:pointer;
      background:var(--card);
      padding:12px 16px;
      border-radius:999px;
      box-shadow:var(--shadow);
      font-weight:800;
      color:var(--text);
      transition: transform .25s ease, box-shadow .25s ease, background .25s ease;
    }
    .tab:hover{ transform:translateY(-3px); }
    .tab.active{
      background:linear-gradient(135deg,#fff0f7,#f5f3ff,#effaff);
      box-shadow:0 0 0 4px var(--ring), var(--shadow);
      color:var(--pink);
    }

    .grid{ display:grid; grid-template-columns: 1.3fr .7fr; gap:18px; }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
      animation: fadeUp .9s ease both;
      transition: transform .35s ease, box-shadow .35s ease;
    }
    .card:hover{ transform:translateY(-6px); box-shadow:0 18px 40px rgba(0,0,0,.12); }

    .card h2, .sectionTitle{ color:var(--pink); margin:0 0 10px; }
    .muted{ color:var(--muted); }

    .kpis{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .kpi{
      background:linear-gradient(180deg,#ffffff,#fff7fb);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      animation: scaleIn .6s ease both;
    }
    .kpi .label{ font-size:13px; color:var(--muted); }
    .kpi .value{ font-size:28px; font-weight:900; color:var(--purple); }

    .charts{ display:grid; gap:16px; }
    canvas{ background:#fff; border-radius:16px; padding:14px; box-shadow:var(--shadow); max-height:420px; width:100%; }

    .status{ margin-top:10px; font-size:14px; }
    .status.ok{ color:#059669; }
    .status.err{ color:#dc2626; }

    .list{ display:grid; gap:10px; }
    .item{ border:1px solid #eef2f7; border-radius:14px; padding:12px; background:#fff; }
    .item b{ color:var(--purple); }

    .gallery{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .photo{ width:100%; aspect-ratio:4/3; object-fit:cover; border-radius:16px; box-shadow:var(--shadow); cursor:pointer; transition: transform .25s ease; background:#f3f4f6; }
    .photo:hover{ transform:scale(1.04); }

    footer{
      text-align:center;
      padding:18px;
      color:var(--muted);
      font-size:14px;
      animation: fadeUp .9s ease both .45s;
    }

    .cta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      background:linear-gradient(135deg,#fff0f7,#f5f3ff,#effaff);
      color:var(--text);
      font-weight:800;
      border:1px solid rgba(0,0,0,.06);
      transition: transform .25s ease, box-shadow .25s ease;
    }
    .btn:hover{ transform:translateY(-3px); box-shadow:0 16px 30px rgba(0,0,0,.12); }

    [hidden]{ display:none !important; }

    /* Lightbox */
    .lb{ position:fixed; inset:0; display:none; background:rgba(0,0,0,.75); z-index:9999; padding:14px; }
    .lb.open{ display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .lbClose{ position:absolute; top:12px; right:12px; width:44px; height:44px; border-radius:999px; background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.25); color:#fff; cursor:pointer; font-size:18px; }
    .lbNav{ position:absolute; top:50%; transform:translateY(-50%); width:54px; height:54px; border-radius:999px; background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.25); color:#fff; cursor:pointer; font-size:46px; display:grid; place-items:center; }
    .lbPrev{ left:12px; }
    .lbNext{ right:12px; }
    .lbStage{ width:min(1100px, 98vw); height:min(70vh, 560px); display:flex; align-items:center; justify-content:center; }
    .lbMedia{ width:100%; height:100%; border:0; border-radius:18px; box-shadow:0 20px 50px rgba(0,0,0,.35); background:#111; object-fit:contain; display:none; }
    .lbCaption{ color:#fff; margin-top:10px; text-align:center; opacity:.92; }
    .lbThumbs{ width:min(1100px, 98vw); display:flex; gap:10px; overflow:auto; padding:10px 2px 4px; margin-top:10px; }
    .lbThumb{ flex:0 0 auto; width:86px; height:56px; border-radius:12px; border:2px solid rgba(255,255,255,.22); overflow:hidden; background:rgba(255,255,255,.08); cursor:pointer; opacity:.85; transition: transform .2s ease, opacity .2s ease, border-color .2s ease; }
    .lbThumb:hover{ transform:translateY(-2px); opacity:1; }
    .lbThumb.active{ border-color: rgba(236,72,153,.95); opacity:1; }
    .lbThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .lbThumb .play{ width:100%; height:100%; display:grid; place-items:center; color:#fff; font-size:18px; background:linear-gradient(135deg, rgba(236,72,153,.35), rgba(56,189,248,.25)); }

    @media (max-width: 1024px){ .grid{ grid-template-columns:1fr; } }
    @media (max-width: 768px){
      header h1{ font-size:24px; }
      .kpis{ grid-template-columns:1fr; }
      canvas{ max-height:320px; }
      .gallery{ grid-template-columns:repeat(2,1fr); }
      .lbStage{ height:min(56vh, 420px); }
      .lbNav{ width:48px; height:48px; font-size:40px; }
      .lbThumb{ width:74px; height:50px; }
    }
    @media (max-width: 480px){
      header{ padding:20px 12px; }
      header p{ font-size:14px; }
      .pill{ font-size:12px; padding:8px 10px; }
      .tab{ padding:10px 12px; font-size:14px; }
      .card{ padding:14px; }
      canvas{ max-height:260px; }
      .gallery{ grid-template-columns:1fr; }
    }

    @keyframes fadeUp{ from{ opacity:0; transform:translateY(18px);} to{opacity:1; transform:none;} }
    @keyframes fadeDown{ from{ opacity:0; transform:translateY(-18px);} to{opacity:1; transform:none;} }
    @keyframes scaleIn{ from{ opacity:0; transform:scale(.92);} to{opacity:1; transform:scale(1);} }

    @media (prefers-reduced-motion: reduce){ *{ animation:none!important; transition:none!important; } }
  </style>
</head>
<body>

<div id="lightbox" class="lb" aria-hidden="true">
  <button id="lbClose" class="lbClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
  <button id="lbPrev" class="lbNav lbPrev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚">â®</button>

  <div class="lbStage">
    <img id="lightboxImg" class="lbMedia" alt="" />
    <iframe id="lightboxYt" class="lbMedia" title="YouTube" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
  </div>

  <button id="lbNext" class="lbNav lbNext" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ">â¯</button>
  <div id="lbCaption" class="lbCaption"></div>
  <div id="lbThumbs" class="lbThumbs" aria-label="Ù…ØµØºØ±Ø§Øª"></div>
</div>

<header>
  <h1>Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„Ø¹Ù‚Ù„ ÙŠØªÙ†ÙØ³</h1>
  <p>ÙˆÙ‚Ù ØªØ¹Ù„ÙŠÙ…ÙŠ â€“ STEM | Ø±Ø¤ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© 2030</p>
</header>

<div class="wrap">

  <div class="topbar">
    <div class="pill">ğŸ“… Ø³Ù†Ø© Ø§Ù„ØªØ£Ø³ÙŠØ³: <b>2018</b></div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="overview">DashBoard</button>
    <button class="tab" data-tab="consulting">Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</button>
    <button class="tab" data-tab="achievements">Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</button>
    <button class="tab" data-tab="photos">Ø§Ù„ØµÙˆØ±</button>
    <button class="tab" data-tab="partners">Ø§Ù„Ø´Ø±ÙƒØ§Ø¡</button>
  </div>

  <section id="tab-overview">
    <div class="grid">
      <div class="card">
        <h2>Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©</h2>
        <p>
          <b>Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„Ø¹Ù‚Ù„ ÙŠØªÙ†ÙØ³</b> Ù…Ø¨Ø§Ø¯Ø±Ø© <b>ÙˆÙ‚Ù ØªØ¹Ù„ÙŠÙ…ÙŠ</b> ØªØ£Ø³Ø³Øª Ø¹Ø§Ù… <b>2018</b>ØŒ
          ØªÙØ¹Ù†Ù‰ Ø¨ØªÙ†Ù…ÙŠØ© Ø§Ù„ØªÙÙƒÙŠØ± ÙˆØ§Ù„Ø§Ø¨ØªÙƒØ§Ø± Ø¹Ø¨Ø± Ù…Ø´Ø§Ø±ÙŠØ¹ ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ <b>STEM</b>ØŒ
          ÙˆØ¨Ù…Ø§ ÙŠÙ†Ø³Ø¬Ù… Ù…Ø¹ Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª <b>Ø±Ø¤ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© 2030</b>.
        </p>
        <div id="status" class="status muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦</div>
        <div id="debug" class="muted" style="margin-top:10px; display:none; background:#fff; border:1px dashed #e5e7eb; padding:10px; border-radius:14px; line-height:1.8;"></div>
      </div>

      <div class="card">
        <h2>Ù…Ù„Ø®Øµ Ø¥Ø­ØµØ§Ø¦ÙŠ</h2>
        <div class="kpis">
          <div class="kpi"><div class="label">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div><div id="kpiProjects" class="value">â€”</div></div>
          <div class="kpi"><div class="label">Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª</div><div id="kpiEvents" class="value">â€”</div></div>
          <div class="kpi"><div class="label">Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙˆÙ†</div><div id="kpiTrainees" class="value">â€”</div></div>
        </div>
        <div class="cta">
          <a class="btn" href="https://noofkhabti.my.canva.site/dag-oorc6gq" target="_blank" rel="noopener">ğŸ§  ØµÙØ­Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</a>
        </div>
      </div>
    </div>

    <div class="charts" style="margin-top:16px;">
      <div class="card"><h3 class="sectionTitle">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø³Ù†Ø©</h3><canvas id="projectsChart"></canvas></div>
      <div class="card"><h3 class="sectionTitle">Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</h3><canvas id="eventsChart"></canvas></div>
      <div class="card"><h3 class="sectionTitle">Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙˆÙ† (Ø·Ù„Ø§Ø¨ / Ø·Ø§Ù„Ø¨Ø§Øª)</h3><canvas id="studentsChart"></canvas></div>
      <div class="card"><h3 class="sectionTitle">Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙˆÙ† Ø³Ù†ÙˆÙŠÙ‹Ø§</h3><canvas id="traineesByYearChart"></canvas></div>
    </div>
  </section>

  <section id="tab-consulting" hidden>
    <div class="card">
      <h2>Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</h2>
      <p class="muted" style="line-height:1.9; margin-top:0;">Ù„Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ù†Ù…Ø§Ø°Ø¬:</p>
      <a class="btn" href="https://noofkhabti.my.canva.site/dag-oorc6gq" target="_blank" rel="noopener">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª</a>
    </div>
  </section>

  <section id="tab-achievements" hidden>
    <div class="card">
      <h2>Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</h2>
      <div id="achievementsList" class="list"></div>
    </div>
  </section>

  <section id="tab-photos" hidden>
    <div class="card">
      <h2>Ø§Ù„ØµÙˆØ±</h2>
      <div id="photosGrid" class="gallery"></div>
    </div>
  </section>

  <section id="tab-partners" hidden>
    <div class="card">
      <h2>Ø§Ù„Ø´Ø±ÙƒØ§Ø¡</h2>
      <div id="partnersList" class="list"></div>
    </div>
  </section>

</div>

<footer>Â© Ù†ÙˆÙ Ø®Ø¨ØªÙŠ â€” Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„Ø¹Ù‚Ù„ ÙŠØªÙ†ÙØ³</footer>

<script>
  const SHEETS = {
    projects: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTdJoeiY6gtt0NaEWYFZxmhMYxT-0EPug4za-8Wl1xXI8o6PYlLn56g-Dv15i0dqsENN9Zai1ROlMA6/pub?output=csv",
    events: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQc-r6wYcwCrEnYNn1A7iFr9Lj9wi78N2-w1enXOA3UgrRSccpLkL-wi4wuO8c45ItTo2Pzz0AP7p6l/pub?output=csv",
    trainees: "https://docs.google.com/spreadsheets/d/e/2PACX-1vS7jelgXvthN4fFi_HnZ0N9WZqOqUE1tb7sj_fH6GFDvaxQE7jZqVXQrTo2_WF8QLzHDOjHc2MPsTDc/pub?output=csv",
    achievements: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSdRNIFnC84P61R0LD57jfhTPO0iX6elBHk1wx4kDM-V9fr9EgUGp7caAhU736nymYZ317-v1sQzZ8Y/pub?output=csv",
    photos: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuaJBwN-JC6L2ANhu3tBITSSlY8Ph_11A-8YMF6_aNVrTX7zfZYBRWsW19qv3Sav0TniXmWWkZpMYA/pub?output=csv",
    partners: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSi20NWBWlJKeq8P9g_YGTVI8bilx6GNwzrvW3co1_R4bdN6n3B-q7akjVs0AIcFsiSi8C1eFGGxhG/pub?output=csv",
  };

  const num = (v) => {
    const n = Number(String(v ?? "").replace(/[^0-9.\-]/g, ""));
    return Number.isFinite(n) ? n : 0;
  };

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }

  function splitCsvLine(line){
    const out=[]; let cur=""; let q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){
        if(q && line[i+1]==='"'){ cur+='"'; i++; }
        else q=!q;
      } else if(c===',' && !q){ out.push(cur); cur=""; }
      else cur+=c;
    }
    out.push(cur);
    return out.map(s=>s.trim());
  }

  function parseCsv(text){
    const raw = String(text ?? "").split("
").map(l=>l.replace("
",""));
    const lines = raw.filter(l=>l.trim().length);
    if(!lines.length) return [];
    let headers = splitCsvLine(lines[0]).map(h=>h.trim());
    if(headers.length && headers[0] && headers[0].charCodeAt(0)===65279){
      headers[0] = headers[0].slice(1);
    }
    return lines.slice(1).map(l=>{
      const cells = splitCsvLine(l);
      const obj={};
      headers.forEach((h,idx)=> obj[h]= (cells[idx] ?? "").trim());
      return obj;
    });
  }

  async function loadCSV(url){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), 15000);
    let res;
    try{ res = await fetch(url, { cache:'no-store', signal: ctrl.signal }); }
    catch(e){ clearTimeout(t); throw new Error('Fetch failed (Ø´Ø¨ÙƒØ©/Ø­Ø¬Ø¨/CORS)'); }
    clearTimeout(t);
    if(!res.ok) throw new Error('CSV HTTP ' + res.status);
    const text = await res.text();
    const rows = parseCsv(text);
    if(!rows.length) throw new Error('Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø§ ÙŠØ±Ø¬Ø¹ CSV (ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø§Ù„Ù†Ø´Ø± Public ÙƒÙ€ CSV)');
    return rows;
  }

  function setStatus(msg, ok){
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = 'status ' + (ok ? 'ok' : 'err');
  }

  function animateCountUp(el, to, ms=900){
    const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if(reduce){ el.textContent = Math.round(to).toLocaleString('ar-SA'); return; }
    const start = performance.now();
    const tick = (t)=>{
      const p = Math.min(1, (t-start)/ms);
      const eased = 1 - Math.pow(1-p, 3);
      el.textContent = Math.round(to*eased).toLocaleString('ar-SA');
      if(p<1) requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }

  let chProjects=null, chEvents=null, chStudents=null, chTraineesByYear=null;
  const destroy = (ch)=>{ if(ch) ch.destroy(); return null; };

  function renderCharts(projects, events, trainees){
    const yearsP = projects.map(r=>String(r.Year ?? r.year ?? '').trim()).filter(Boolean);
    const countsP = projects.map(r=>num(r.ProjectsCount ?? r.projects ?? r.Count ?? r.count));

    const labelsE = events.map(r=>String(r.Type ?? r.type ?? r.Category ?? r.category ?? '').trim()).filter(Boolean);
    const countsE = events.map(r=>num(r.Count ?? r.count ?? r.EventsCount ?? r.events));

    const yearsT = trainees.map(r=>String(r.Year ?? r.year ?? '').trim()).filter(Boolean);
    const female = trainees.map(r=>num(r.Female ?? r.female ?? r.Girls ?? r.girls));
    const male   = trainees.map(r=>num(r.Male ?? r.male ?? r.Boys ?? r.boys));

    animateCountUp(document.getElementById('kpiProjects'), countsP.reduce((a,b)=>a+b,0));
    animateCountUp(document.getElementById('kpiEvents'), countsE.reduce((a,b)=>a+b,0));
    animateCountUp(document.getElementById('kpiTrainees'), female.reduce((a,b)=>a+b,0) + male.reduce((a,b)=>a+b,0));

    chProjects = destroy(chProjects);
    chProjects = new Chart(document.getElementById('projectsChart'),{
      type:'line',
      data:{ labels:yearsP, datasets:[{ label:'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹', data:countsP, tension:0.35, fill:true }] },
      options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });

    chEvents = destroy(chEvents);
    chEvents = new Chart(document.getElementById('eventsChart'),{
      type:'bar',
      data:{ labels:labelsE, datasets:[{ label:'Ø¹Ø¯Ø¯ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª', data:countsE }] },
      options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });

    chStudents = destroy(chStudents);
    const sumF = female.reduce((a,b)=>a+b,0);
    const sumM = male.reduce((a,b)=>a+b,0);
    chStudents = new Chart(document.getElementById('studentsChart'),{
      type:'doughnut',
      data:{ labels:['Ø·Ø§Ù„Ø¨Ø§Øª','Ø·Ù„Ø§Ø¨'], datasets:[{ data:[sumF,sumM] }] },
      options:{ plugins:{ legend:{ position:'bottom' } } }
    });

    chTraineesByYear = destroy(chTraineesByYear);
    chTraineesByYear = new Chart(document.getElementById('traineesByYearChart'),{
      type:'line',
      data:{ labels:yearsT, datasets:[{ label:'Ø·Ø§Ù„Ø¨Ø§Øª', data:female, tension:0.35 },{ label:'Ø·Ù„Ø§Ø¨', data:male, tension:0.35 }] },
      options:{ plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function renderAchievements(rows){
    const box = document.getElementById('achievementsList');
    box.innerHTML = '';
    if(!rows.length){ box.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>'; return; }
    rows.slice(0,120).forEach(r=>{
      const title = r.Title ?? r.title ?? 'Ø¥Ù†Ø¬Ø§Ø²';
      const date = r.Date ?? r.date ?? '';
      const desc = r.Description ?? r.description ?? '';
      const el = document.createElement('div');
      el.className='item';
      el.innerHTML = '<b>' + escapeHtml(title) + '</b> <span class="muted">' + escapeHtml(date) + '</span><div class="muted" style="margin-top:6px; line-height:1.7;">' + escapeHtml(desc) + '</div>';
      box.appendChild(el);
    });
  }

  function renderPartners(rows){
    const box = document.getElementById('partnersList');
    box.innerHTML = '';
    if(!rows.length){ box.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>'; return; }
    rows.slice(0,120).forEach(r=>{
      const name = r.Name ?? r.name ?? 'Ø´Ø±ÙŠÙƒ';
      const type = r.Type ?? r.type ?? '';
      const note = r.Note ?? r.note ?? '';
      const el = document.createElement('div');
      el.className='item';
      el.innerHTML = '<b>' + escapeHtml(name) + '</b> <span class="muted">' + escapeHtml(type) + '</span><div class="muted" style="margin-top:6px; line-height:1.7;">' + escapeHtml(note) + '</div>';
      box.appendChild(el);
    });
  }

  function toDirectImageUrl(raw){
    const s = String(raw ?? '').trim();
    if(!s) return null;
    let id = null;
    if(s.includes('file/d/')){
      const a = s.split('file/d/')[1];
      if(a) id = a.split('/')[0];
    }
    if(!id && s.includes('id=')){
      const a = s.split('id=')[1];
      if(a) id = a.split('&')[0];
    }
    if(!id) return s;

    return {
      thumb: 'https://drive.google.com/thumbnail?id=' + id + '&sz=w1600',
      view1: 'https://drive.google.com/uc?export=view&id=' + id,
      view2: 'https://drive.usercontent.google.com/uc?id=' + id + '&export=view'
    };
  }

  function isYouTube(u){
    const s = String(u ?? '').toLowerCase();
    return s.includes('youtube.com') || s.includes('youtu.be');
  }

  function getYouTubeId(u){
    try{
      const url = new URL(String(u));
      if(url.hostname.includes('youtu.be')) return url.pathname.replace('/','');
      if(url.searchParams.get('v')) return url.searchParams.get('v');
      const parts = url.pathname.split('/').filter(Boolean);
      const idx = parts.indexOf('embed');
      if(idx>=0 && parts[idx+1]) return parts[idx+1];
    } catch(e){
      return null;
    }
    return null;
  }

  function ytThumb(id){ return 'https://i.ytimg.com/vi/' + id + '/mqdefault.jpg'; }

  function renderPhotos(rows){
    const grid = document.getElementById('photosGrid');
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightboxImg');
    const lbYt = document.getElementById('lightboxYt');
    const lbPrev = document.getElementById('lbPrev');
    const lbNext = document.getElementById('lbNext');
    const lbClose = document.getElementById('lbClose');
    const lbThumbs = document.getElementById('lbThumbs');
    const lbCaption = document.getElementById('lbCaption');

    const items = [];
    let current = 0;

    function openLb(){ lb.classList.add('open'); lb.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function closeLb(){ lb.classList.remove('open'); lb.setAttribute('aria-hidden','true'); document.body.style.overflow=''; lbYt.src=''; }

    function setMedia(type){
      lbImg.style.display = type==='image' ? 'block' : 'none';
      lbYt.style.display  = type==='youtube' ? 'block' : 'none';
      if(type!=='youtube') lbYt.src='';
    }

    function renderThumbs(){
      lbThumbs.innerHTML='';
      items.forEach((it,idx)=>{
        const d = document.createElement('div');
        d.className = 'lbThumb' + (idx===current ? ' active':'' );
        if(it.type==='image'){
          const im = document.createElement('img'); im.src = it.thumb; im.alt=''; d.appendChild(im);
        } else {
          const play = document.createElement('div'); play.className='play'; play.textContent='â–¶'; d.appendChild(play);
        }
        d.onclick = ()=> show(idx);
        lbThumbs.appendChild(d);
      });
    }

    function show(i){
      if(!items.length) return;
      if(i<0) i = items.length-1;
      if(i>=items.length) i = 0;
      current = i;
      const it = items[current];
      lbCaption.textContent = it.caption || '';

      if(it.type==='image'){
        setMedia('image');
        let tries = 0;
        const cands = it.candidates;
        lbImg.onerror = ()=>{
          tries++;
          if(tries < cands.length) lbImg.src = cands[tries];
        };
        lbImg.src = cands[0];
      } else {
        setMedia('youtube');
        lbYt.src = 'https://www.youtube.com/embed/' + it.ytid + '?rel=0';
      }
      renderThumbs();
    }

    const next = ()=> show(current+1);
    const prev = ()=> show(current-1);

    grid.innerHTML='';
    if(!rows.length){ grid.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±.</div>'; return; }

    rows.slice(0,120).forEach(r=>{
      const raw = r.ImageURL ?? r.image ?? r.URL ?? r.url;
      if(!raw) return;
      const cap = r.Caption ?? r.caption ?? '';

      if(isYouTube(raw)){
        const id = getYouTubeId(raw);
        if(!id) return;
        const thumb = ytThumb(id);
        const index = items.length;
        items.push({ type:'youtube', ytid:id, thumb:thumb, caption:cap });

        const wrap = document.createElement('div');
        const img = document.createElement('img');
        img.className='photo'; img.loading='lazy'; img.src = thumb; img.alt = cap || 'ÙÙŠØ¯ÙŠÙˆ';
        img.onclick = ()=>{ openLb(); show(index); };
        wrap.appendChild(img);
        if(cap){ const c = document.createElement('div'); c.className='muted'; c.style.marginTop='6px'; c.textContent=cap; wrap.appendChild(c); }
        grid.appendChild(wrap);
        return;
      }

      const d = toDirectImageUrl(raw);
      const candidates = (typeof d === 'string') ? [d] : [d.thumb, d.view2, d.view1];
      const index = items.length;
      items.push({ type:'image', candidates:candidates, thumb:candidates[0], caption:cap });

      const wrap = document.createElement('div');
      const img = document.createElement('img');
      img.className='photo'; img.loading='lazy'; img.alt = cap || 'ØµÙˆØ±Ø©';

      let tries = 0;
      img.onerror = ()=>{ tries++; if(tries < candidates.length) img.src = candidates[tries]; };
      img.src = candidates[0];
      img.onclick = ()=>{ openLb(); show(index); };

      wrap.appendChild(img);
      if(cap){ const c = document.createElement('div'); c.className='muted'; c.style.marginTop='6px'; c.textContent=cap; wrap.appendChild(c); }
      grid.appendChild(wrap);
    });

    lbPrev.onclick = (e)=>{ e.stopPropagation(); prev(); };
    lbNext.onclick = (e)=>{ e.stopPropagation(); next(); };
    lbClose.onclick = (e)=>{ e.stopPropagation(); closeLb(); };
    lb.addEventListener('click', (e)=>{ if(e.target===lb) closeLb(); });

    document.addEventListener('keydown', (e)=>{
      if(!lb.classList.contains('open')) return;
      if(e.key==='ArrowRight') next();
      if(e.key==='ArrowLeft') prev();
      if(e.key==='Escape') closeLb();
    });
  }

  const panes = Array.from(document.querySelectorAll('section[id^="tab-"]'));
  function showPane(id){
    panes.forEach(p=> p.hidden = (p.id !== id));
    if(id === 'tab-overview'){
      setTimeout(()=>{ try{ chProjects && chProjects.resize(); }catch(e){} }, 120);
    }
  }
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      showPane('tab-' + btn.dataset.tab);
    });
  });
  showPane('tab-overview');

  (async()=>{
    const debug = document.getElementById('debug');
    try{
      setStatus('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦', true);
      const results = await Promise.allSettled([
        loadCSV(SHEETS.projects),
        loadCSV(SHEETS.events),
        loadCSV(SHEETS.trainees),
        loadCSV(SHEETS.achievements),
        loadCSV(SHEETS.photos),
        loadCSV(SHEETS.partners),
      ]);

      const names = ['projects','events','trainees','achievements','photos','partners'];
      const data = {};
      const failed = [];
      results.forEach((r,i)=>{
        if(r.status==='fulfilled') data[names[i]] = r.value;
        else failed.push(names[i]);
      });

      if(data.projects && data.events && data.trainees) renderCharts(data.projects, data.events, data.trainees);
      if(data.achievements) renderAchievements(data.achievements);
      if(data.photos) renderPhotos(data.photos);
      if(data.partners) renderPartners(data.partners);

      if(failed.length){
        setStatus('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…', true);
        debug.style.display='block';
        debug.textContent = 'Ù„Ù… ØªÙØ­Ù…Ù‘Ù„: ' + failed.join('ØŒ ') + ' â€” Ø§ÙØªØ­ÙŠ Console Ù„Ù„ØªÙØ§ØµÙŠÙ„.';
        console.warn('Load failed sheets:', failed);
      } else {
        setStatus('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…', true);
      }
    } catch(e){
      console.error(e);
      setStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„/Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', false);
      debug.style.display='block';
      debug.textContent = String(e && e.message ? e.message : e);
    }
  })();

  (function runTests(){
    try{
      const sample = ['Year,ProjectsCount','2018,2','2019,4',''].join('
');
      const rows = parseCsv(sample);
      console.assert(rows.length===2, 'CSV rows length');
      console.assert(rows[0].Year==='2018', 'CSV Year');
    } catch(e){ console.error('Tests failed', e); }
  })();
</script>

</body>
</html>
